import React, { useState, useRef } from 'react';
import { X, Camera, Share2, Info, Loader2, Sparkles, Beer, Users, Flame, MapPin, Gamepad2, Clock, Zap, AlertTriangle, ShieldCheck } from 'lucide-react';
import { Venue, VenueStatus, GameStatus } from '../../../types';
import { getGameTTL } from '../../../config/gameConfig';
import { useGeolocation } from '../../../hooks/useGeolocation';
import { calculateDistance } from '../../../utils/geoUtils';

interface VibeCheckModalProps {
    isOpen: boolean;
    onClose: () => void;
    venue: Venue;
    onConfirm: (venue: Venue, status: VenueStatus, hasConsent: boolean, photoUrl?: string, verificationMethod?: 'gps' | 'qr', gameStatus?: Record<string, GameStatus>, soberCheck?: { isGood: boolean; reason?: string }) => void;
    clockedIn?: boolean;
    onClockInPrompt?: () => void;
    verificationMethod?: 'gps' | 'qr';
    isLoggedIn?: boolean;
    onLogin?: (mode: 'login' | 'signup') => void;
}

export const VibeCheckModal: React.FC<VibeCheckModalProps> = ({
    isOpen,
    onClose,
    venue,
    onConfirm,
    clockedIn,
    onClockInPrompt,
    verificationMethod = 'gps',
    isLoggedIn = false,
    onLogin
}) => {
    const [selectedStatus, setSelectedStatus] = useState<VenueStatus>(venue.status || 'chill');
    const [showCamera, setShowCamera] = useState(false);
    const [capturedPhoto, setCapturedPhoto] = useState<string | null>(null);
    const [cameraError, setCameraError] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [allowMarketingUse, setAllowMarketingUse] = useState(false);
    const [isSuccess, setIsSuccess] = useState(false);
    const [errorMessage, setErrorMessage] = useState<string | null>(null);

    // Initialize with existing status or empty
    const [gameStatus, setGameStatus] = useState<Record<string, GameStatus>>(venue.liveGameStatus || {});

    // [SOBER FRIENDLY] State
    const [soberCheck, setSoberCheck] = useState<{ isGood: boolean; reason?: string } | null>(null);
    const [showSoberReason, setShowSoberReason] = useState(false);

    const videoRef = useRef<HTMLVideoElement | null>(null);
    const canvasRef = useRef<HTMLCanvasElement | null>(null);

    const { coords, loading: geoLoading, requestLocation, refresh } = useGeolocation();

    if (!isOpen) return null;

    const currentDistance = coords && venue.location
        ? calculateDistance(coords.latitude, coords.longitude, venue.location.lat, venue.location.lng)
        : null;

    const isLocalhost = typeof window !== 'undefined' && window.location.hostname === 'localhost';
    const isAtVenue = (currentDistance !== null && currentDistance <= 25) || isLocalhost;

    const startCamera = async () => {
        setCameraError(false);
        setShowCamera(true);
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                await videoRef.current.play();
            }
        } catch (err) {
            console.error("Camera access denied", err);
            setCameraError(true);
            setShowCamera(false);
        }
    };

    const stopCamera = () => {
        if (videoRef.current && videoRef.current.srcObject) {
            const stream = videoRef.current.srcObject as MediaStream;
            stream.getTracks().forEach(track => track.stop());
        }
        setShowCamera(false);
    };

    const capturePhoto = () => {
        if (videoRef.current && canvasRef.current) {
            const context = canvasRef.current.getContext('2d');
            if (context) {
                canvasRef.current.width = videoRef.current.videoWidth;
                canvasRef.current.height = videoRef.current.videoHeight;
                context.drawImage(videoRef.current, 0, 0);
                const dataUrl = canvasRef.current.toDataURL('image/jpeg');
                setCapturedPhoto(dataUrl);
                stopCamera();
            }
        }
    };

    const handleConfirm = async () => {
        if (!isAtVenue) {
            setErrorMessage("Coordinate Verification Failed. You must be at the venue to submit a vibe.");
            return;
        }

        setIsSubmitting(true);
        setErrorMessage(null);

        try {
            await onConfirm(venue, selectedStatus, allowMarketingUse, capturedPhoto || undefined, verificationMethod, Object.keys(gameStatus).length > 0 ? gameStatus : undefined, soberCheck || undefined);
            setIsSuccess(true);

            if (clockedIn) {
                setTimeout(onClose, 2000);
            }
        } catch (err: any) {
            setErrorMessage(err.message || "Failed to submit vibe.");
        } finally {
            setIsSubmitting(false);
        }
    };

    const vibeOptions: { status: VenueStatus; label: string; icon: any; color: string; desc: string }[] = [
        { status: 'dead', label: 'Dead', icon: Clock, color: 'text-slate-500', desc: 'Empty, almost no one here' },
        { status: 'chill', label: 'Chill', icon: Beer, color: 'text-blue-400', desc: 'Relaxed, plenty of space' },
        { status: 'buzzing', label: 'Buzzing', icon: Flame, color: 'text-red-500', desc: 'Active, good energy!' },
        { status: 'packed', label: 'Packed', icon: Zap, color: 'text-pink-500', desc: 'Shoulder to shoulder, wild!' },
    ];

    if (isSuccess) {
        return (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] flex items-center justify-center p-4 animate-in fade-in duration-300">
                <div className="bg-surface w-full max-w-sm rounded-2xl border-2 border-primary shadow-[0_0_50px_-12px_rgba(251,191,36,0.5)] overflow-hidden text-center p-8 space-y-6">
                    <div className="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto animate-bounce">
                        <Sparkles className="w-10 h-10 text-black" />
                    </div>
                    <div>
                        <h2 className="text-3xl font-black text-white uppercase tracking-tighter font-league italic">Vibe Submitted!</h2>
                        {isLoggedIn ? (
                            <p className="text-primary font-black uppercase tracking-widest text-xs mt-1">LEAGUE XP GRANTED</p>
                        ) : (
                            <p className="text-primary font-black uppercase tracking-widest text-xs mt-1">XP PENDING CLAIM</p>
                        )}
                    </div>

                    {!clockedIn && onClockInPrompt ? (
                        <div className="bg-slate-900/80 p-4 rounded-xl border border-white/5 space-y-4">
                            <p className="text-slate-300 text-sm font-bold leading-tight">
                                Nice vibe! Since you're here, want to <span className="text-primary italic">Clock In</span> for +10 more points?
                            </p>
                            <button
                                onClick={onClockInPrompt}
                                className="w-full bg-white text-black font-black py-3 rounded-lg uppercase tracking-wider font-league hover:scale-105 transition-transform flex items-center justify-center gap-2"
                            >
                                <MapPin className="w-5 h-5" /> Clock In Now
                            </button>
                            <button onClick={onClose} className="text-slate-500 text-[10px] font-bold uppercase tracking-widest hover:text-white">Maybe Later</button>
                        </div>
                    ) : (
                        !isLoggedIn && onLogin ? (
                            <div className="bg-primary/10 rounded-xl p-4 border border-primary/20 space-y-3">
                                <p className="text-[10px] text-primary font-bold uppercase tracking-widest">Claim Your Rewards</p>
                                <button
                                    onClick={() => onLogin('signup')}
                                    className="w-full bg-primary text-black font-black py-3 rounded-lg uppercase tracking-wider font-league hover:scale-105 transition-transform"
                                >
                                    Join League to Save
                                </button>
                                <button onClick={onClose} className="text-slate-500 text-[10px] font-bold uppercase tracking-widest hover:text-white">Close & Lose Points</button>
                            </div>
                        ) : (
                            <p className="text-slate-400 text-xs font-medium italic">Redirecting to status hub...</p>
                        )
                    )}
                </div>
            </div>
        );
    }

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-in zoom-in-95 duration-200">
            <div className="bg-surface w-full max-w-sm overflow-hidden rounded-xl border border-slate-700 shadow-lg relative">

                {showCamera && (
                    <div className="absolute inset-0 z-[70] bg-black flex flex-col">
                        <video ref={videoRef} autoPlay playsInline className="flex-1 object-cover w-full" />
                        <canvas ref={canvasRef} className="hidden" />
                        <div className="p-4 bg-black/50 flex justify-between items-center absolute bottom-0 w-full border-t border-primary/20">
                            <button onClick={stopCamera} className="font-bold uppercase tracking-wider text-sm text-white">Cancel</button>
                            <button onClick={capturePhoto} className="w-16 h-16 bg-white rounded-full border-4 border-primary shadow-xl active:scale-95 transition-transform"></button>
                            <div className="w-16"></div>
                        </div>
                    </div>
                )}

                <div className="bg-primary p-4 text-center border-b border-black/10 relative">
                    <button onClick={onClose} className="absolute top-3 right-3 text-black/70 hover:text-black hover:scale-110 transition-transform"><X className="w-6 h-6" /></button>
                    <h2 className="text-2xl font-black text-black uppercase tracking-wider font-league italic">Vibe Check</h2>
                    <p className="text-black/60 text-[10px] font-black uppercase tracking-widest font-league leading-none">{venue.name}</p>
                </div>

                <div className="p-4 space-y-4">
                    <div className="text-center">
                        <p className={`text-[10px] font-black uppercase tracking-widest ${isAtVenue ? 'text-primary' : (currentDistance !== null ? 'text-red-400' : 'text-slate-500')}`}>
                            {geoLoading ? 'Finding you...' : (isLocalhost ? '💻 DEV MODE: GPS BYPASS' : (isAtVenue ? '📍 Verified At Venue' : (currentDistance !== null ? `${Math.round(currentDistance)}m FROM VENUE` : '🚶 Location Check Required')))}
                        </p>
                        {!isAtVenue && !geoLoading && (
                            <button
                                onClick={refresh}
                                className="mt-2 text-[10px] bg-primary/20 text-primary font-black px-3 py-1 rounded-full border border-primary/30 hover:bg-primary/30 transition-all uppercase tracking-widest"
                            >
                                {coords ? 'Verify Again' : 'Verify My Location'}
                            </button>
                        )}
                    </div>

                    {/* Vibe Selection */}
                    <div className="grid grid-cols-1 gap-2">
                        {vibeOptions.map((opt) => (
                            <button
                                key={opt.status}
                                onClick={() => setSelectedStatus(opt.status)}
                                className={`flex items-center gap-4 p-3 rounded-xl border-2 transition-all text-left ${selectedStatus === opt.status ? 'bg-primary/10 border-primary' : 'bg-slate-800/50 border-slate-700 hover:border-slate-500'}`}
                            >
                                <div className={`p-2 rounded-lg bg-black/40 ${opt.color}`}>
                                    <opt.icon size={20} />
                                </div>
                                <div className="flex-1">
                                    <p className={`font-black uppercase tracking-wider font-league ${selectedStatus === opt.status ? 'text-primary' : 'text-slate-300'}`}>{opt.label}</p>
                                    <p className="text-[10px] text-slate-500 font-bold uppercase">{opt.desc}</p>
                                </div>
                                {selectedStatus === opt.status && (
                                    <div className="w-2 h-2 rounded-full bg-primary animate-pulse" />
                                )}
                            </button>
                        ))}
                    </div>

                </div>

                {/* Game Status Section (Premium) */}
                {venue.hasGameVibeCheckEnabled && venue.gameFeatures && venue.gameFeatures.length > 0 && (
                    <div className="bg-slate-900/50 border border-white/5 rounded-xl p-3 space-y-3">
                        <div className="flex items-center gap-2 mb-2">
                            <Gamepad2 className="w-4 h-4 text-purple-400" />
                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Game Status (Live)</span>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            {venue.gameFeatures.map((feature) => {
                                const current = gameStatus[feature.id]?.status || 'open';
                                const isBroken = current === 'out_of_order';

                                return (
                                    <div key={feature.id} className="bg-black/40 rounded-lg p-2 border border-white/5 flex flex-col gap-2">
                                        <div className="flex items-center justify-between">
                                            <span className="text-xs font-bold text-white truncate flex-1">{feature.name}</span>
                                            <button
                                                onClick={() => {
                                                    if (window.confirm(`Report ${feature.name} as broken?`)) {
                                                        setGameStatus(prev => ({
                                                            ...prev,
                                                            [feature.id]: {
                                                                status: 'out_of_order',
                                                                timestamp: Date.now(),
                                                                reportedBy: 'user'
                                                            }
                                                        }));
                                                    }
                                                }}
                                                className="text-slate-600 hover:text-yellow-400 -mr-1"
                                            >
                                                <AlertTriangle className="w-4 h-4" />
                                            </button>
                                        </div>

                                        {isBroken ? (
                                            <div className="bg-red-500/10 border border-red-500/20 text-red-500 text-[10px] font-black uppercase py-1 text-center rounded flex items-center justify-center gap-1">
                                                <AlertTriangle className="w-3 h-3" />
                                                Needs Repair
                                            </div>
                                        ) : (
                                            <div className="flex bg-slate-800 rounded-lg p-0.5">
                                                <button
                                                    onClick={() => setGameStatus(prev => ({
                                                        ...prev,
                                                        [feature.id]: { status: 'open', timestamp: Date.now(), reportedBy: 'user' }
                                                    }))}
                                                    className={`flex-1 py-1 text-[9px] font-black uppercase rounded-md transition-all ${current === 'open' ? 'bg-green-500 text-black shadow-sm' : 'text-slate-500 hover:text-white'}`}
                                                >
                                                    Open
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        const ttl = getGameTTL(feature.id);
                                                        setGameStatus(prev => ({
                                                            ...prev,
                                                            [feature.id]: {
                                                                status: 'taken',
                                                                timestamp: Date.now(),
                                                                reportedBy: 'user',
                                                                expiresAt: Date.now() + (ttl * 60 * 1000)
                                                            }
                                                        }));
                                                    }}
                                                    className={`flex-1 py-1 text-[9px] font-black uppercase rounded-md transition-all ${current === 'taken' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-500 hover:text-white'}`}
                                                >
                                                    Taken
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* Sober Friendly Feedback (GPS Verified Only) */}
                {venue.isSoberFriendly && isAtVenue && (
                    <div className="bg-blue-900/40 border border-blue-800 rounded-xl p-3 space-y-3">
                        <div className="flex items-center gap-2">
                            <ShieldCheck size={16} className="text-secondary" />
                            <span className="text-[10px] font-black text-white uppercase tracking-widest">Sober Friendly Promise Kept?</span>
                        </div>

                        <div className="flex gap-2">
                            <button
                                onClick={() => {
                                    setSoberCheck({ isGood: true });
                                    setShowSoberReason(false);
                                }}
                                className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all border ${soberCheck?.isGood === true ? 'bg-secondary text-black border-secondary' : 'bg-black/40 text-slate-500 border-white/5'}`}
                            >
                                👍 Yes
                            </button>
                            <button
                                onClick={() => {
                                    setSoberCheck({ isGood: false, reason: 'No Options' });
                                    setShowSoberReason(true);
                                }}
                                className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all border ${soberCheck?.isGood === false ? 'bg-red-500 text-white border-red-500' : 'bg-black/40 text-slate-500 border-white/5'}`}
                            >
                                👎 No
                            </button>
                        </div>

                        {showSoberReason && (
                            <div className="animate-in slide-in-from-top duration-200">
                                <label className="text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1 block">What was missing?</label>
                                <select
                                    value={soberCheck?.reason}
                                    onChange={(e) => setSoberCheck({ isGood: false, reason: e.target.value })}
                                    className="w-full bg-black/60 border border-white/10 rounded-lg p-2 text-[10px] text-white font-bold outline-none focus:border-red-500/50"
                                >
                                    <option value="No Options">No NA Options Beyond Soda</option>
                                    <option value="Bad Service">Poor Service / Pressure to Drink</option>
                                    <option value="Plastic Cup">Served in Plastic (Glassware Fail)</option>
                                </select>
                            </div>
                        )}
                    </div>
                )}

                {/* Optional Photo */}
                <div onClick={capturedPhoto ? undefined : startCamera} className={`border-2 border-dashed rounded-lg p-4 text-center transition-all cursor-pointer group relative overflow-hidden ${capturedPhoto ? 'border-primary/50 bg-black' : 'border-slate-600 bg-surface hover:bg-slate-800 hover:border-primary'}`}>
                    {capturedPhoto ? (
                        <div>
                            <img src={capturedPhoto} alt="Captured Vibe" className="w-full h-24 object-cover rounded-md mb-2" />
                            <button onClick={() => setCapturedPhoto(null)} className="text-[9px] text-slate-400 font-bold uppercase hover:text-white">Retake Photo</button>
                        </div>
                    ) : (
                        <>
                            {cameraError ? (
                                <p className="text-red-500 text-[10px] font-bold">Camera access error. Photo optional.</p>
                            ) : (
                                <div className="flex items-center justify-center gap-2">
                                    <Camera className="w-4 h-4 text-slate-400 group-hover:text-primary" />
                                    <p className="text-[10px] font-black text-slate-300 uppercase italic">Add Vibe Photo (+10 Pts)</p>
                                </div>
                            )}
                        </>
                    )}
                </div>

                {/* Marketing Consent */}
                <div className="bg-slate-900/40 border border-slate-800 rounded-xl p-3 space-y-2">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Sparkles size={14} className={allowMarketingUse ? 'text-primary' : 'text-slate-600'} />
                            <div>
                                <p className="text-[10px] font-black text-white uppercase tracking-wider font-league leading-none">Marketing Consent</p>
                                <p className="text-[8px] text-slate-500 font-bold uppercase italic mt-0.5">Earn +15 Bonus Points!</p>
                            </div>
                        </div>
                        <button
                            onClick={() => setAllowMarketingUse(!allowMarketingUse)}
                            className={`w-8 h-4 rounded-full p-0.5 transition-all ${allowMarketingUse ? 'bg-primary' : 'bg-slate-700'}`}
                        >
                            <div className={`w-3 h-3 rounded-full bg-white transition-all ${allowMarketingUse ? 'translate-x-4' : 'translate-x-0'}`} />
                        </button>
                    </div>
                </div>

                {errorMessage && (
                    <div className="bg-red-900/20 border border-red-800 p-3 rounded-lg text-red-200 text-xs font-bold text-center">
                        ⚠️ {errorMessage}
                    </div>
                )}

                <div className="pt-2 border-t border-slate-800 flex justify-between items-center mb-2">
                    <span className="text-[10px] font-black text-slate-500 uppercase font-league tracking-widest">League Reward</span>
                    <span className="text-sm font-black text-primary uppercase font-league">
                        +{5 + (capturedPhoto ? 10 : 0) + (allowMarketingUse ? 15 : 0)} POINTS
                    </span>
                </div>

                <button
                    onClick={handleConfirm}
                    disabled={isSubmitting || (!isAtVenue && !geoLoading)}
                    className="w-full bg-primary hover:bg-yellow-400 disabled:bg-slate-700 disabled:text-slate-400 text-black font-black text-lg uppercase tracking-widest py-4 rounded-lg shadow-xl active:scale-95 transition-all font-league italic flex items-center justify-center gap-2"
                >
                    {isSubmitting ? (
                        <><Loader2 className="w-5 h-5 animate-spin" /> Transmitting...</>
                    ) : (
                        <>Submit Vibe</>
                    )}
                </button>
            </div>
        </div>
    );
};
