import React, { useState, useEffect, useRef } from 'react';
import { BrowserRouter as Router, Routes, Route, useLocation, useSearchParams, useNavigate } from 'react-router-dom';
import { QueryClientProvider, useQuery } from '@tanstack/react-query';
import { SEO } from './components/common/SEO';
import { X } from 'lucide-react';

// --- CONFIG & TYPES ---
import { queryClient } from './lib/queryClient';
import {
  Venue, PointsReason, UserProfile, ClockInRecord, UserAlertPreferences, VenueStatus, ActivityLog, GameStatus
} from './types';
import { isSystemAdmin } from './types/auth_schema';

// --- REAL SERVICES ---
import { fetchVenues, updateVenueDetails } from './services/venueService';
import {
  saveAlertPreferences, logUserActivity, syncClockIns,
  fetchUserRank,
  toggleFavorite,
  updateUserProfile,
  fetchRecentActivity, // New Export
  performVibeCheck
} from './services/userService';

// --- MODULAR COMPONENTS ---
import { ErrorBoundary } from './components/common/ErrorBoundary';
import { AppShell } from './components/layout/AppShell';
import { BuzzScreen } from './features/venues/screens/BuzzScreen';
import { KaraokeScreen } from './features/league/screens/KaraokeScreen';
import { TriviaScreen } from './features/league/screens/TriviaScreen';
import { LiveMusicScreen } from './features/league/screens/LiveMusicScreen';
import { EventsScreen } from './features/league/screens/EventsScreen';
import { VenuesScreen } from './features/venues/screens/VenuesScreen';
import { LoginModal } from './features/auth/components/LoginModal';
import { OwnerDashboardScreen } from './features/owner/screens/OwnerDashboardScreen';
import { ClockInModal } from './features/venues/components/ClockInModal';
import { OnboardingModal } from './components/ui/OnboardingModal';
import { AgeGate } from './components/ui/AgeGate';
import { VibeCheckModal } from './features/venues/components/VibeCheckModal';
import { MakerSurveyModal } from './features/marketing/components/MakerSurveyModal'; // New Import
import { useToast } from './components/ui/BrandedToast';
import { VibeReceiptModal } from './features/social/components/VibeReceiptModal';
import { VibeReceiptData, generateArtieHook } from './features/social/services/VibeReceiptService';

// --- UTILS & HELPERS ---
import { cookieService } from './services/cookieService';
import { calculateDistance, metersToMiles } from './utils/geoUtils';

// --- RELOCATED SCREENS ---


import { LeagueHQScreen } from './features/league/screens/LeagueHQScreen';
import TermsScreen from './features/marketing/screens/TermsScreen';
import PrivacyScreen from './features/marketing/screens/PrivacyScreen';
import CookiePolicyScreen from './features/marketing/screens/CookiePolicyScreen';
import PartnerSecurityScreen from './features/marketing/screens/PartnerSecurityScreen';
import FAQScreen from './features/marketing/screens/FAQScreen';
import { AdminDashboardScreen } from './features/admin/screens/AdminDashboardScreen';
import UserProfileScreen from './features/profile/screens/UserProfileScreen';
import { VenueProfileScreen } from './features/venues/screens/VenueProfileScreen';
import AboutPage from './features/marketing/screens/About';
import ArtieBioScreen from './features/artie/screens/ArtieBioScreen'; // [NEW] Import
import { DiscoveryLayout } from './features/venues/screens/DiscoveryLayout';
import { DiscoveryProvider } from './features/venues/contexts/DiscoveryContext';
import OwnerPortal from './features/owner/screens/OwnerPortal';
import { PointHistoryScreen } from './features/profile/screens/PointHistoryScreen';
import SettingsScreen from './features/profile/screens/SettingsScreen';
import { QRVibeCheckScreen } from './features/vibe-check/screens/QRVibeCheckScreen'; // [NEW] QR Screen
import MerchStandScreen from './features/merch/screens/MerchStandScreen';
import MerchDetailScreen from './features/merch/screens/MerchDetailScreen';
import VoucherRedemptionScreen from './features/merch/screens/VoucherRedemptionScreen';
import ScrollToTop from './components/layout/ScrollToTop';
import { HistoryFeedScreen } from './features/history/screens/HistoryFeedScreen';
import { HistoryArticleScreen } from './features/history/screens/HistoryArticleScreen';
import { PulsePlaybookScreen } from './features/marketing/screens/PulsePlaybookScreen';
import { PlayGatewayScreen } from './features/play/screens/PlayGatewayScreen'; // [NEW]
import { LeaguePerksScreen } from './features/league/screens/LeaguePerksScreen';
import AIGatewayScreen from './features/marketing/screens/AIGatewayScreen';
import AIFeedGuideScreen from './features/marketing/screens/AIFeedGuideScreen';
import AIConductScreen from './features/marketing/screens/AIConductScreen';
import ClaimVenuePage from './features/owner/screens/ClaimVenuePage';
import GlossaryScreen from './features/marketing/screens/GlossaryScreen';
import PointsGuideScreen from './features/league/screens/PointsGuideScreen';
import LeagueMembershipPage from './features/marketing/LeagueMembershipPage';
import OnboardingHandoverPage from './features/marketing/screens/OnboardingHandoverPage';
import { FlightSchoolScreen } from './features/flights/screens/FlightSchoolScreen'; // [NEW] Flight School Import
import { MetaOAuthCallback } from './features/owner/components/MetaOAuthCallback'; // [NEW] Meta OAuth Callback
import { BackRoomScreen } from './features/venues/screens/BackRoomScreen'; // [NEW]


const InfoPopup = ({ infoContent, setInfoContent }: any) => {
  if (!infoContent) return null;
  return (
    <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6" onClick={() => setInfoContent(null)}>
      <div className="bg-surface border border-white/10 p-6 rounded-2xl shadow-2xl max-w-sm w-full relative" onClick={e => e.stopPropagation()}>
        <h3 className="text-xl font-black text-primary uppercase tracking-wide mb-3 font-league">{infoContent.title}</h3>
        <p className="text-sm text-slate-300 font-medium leading-relaxed font-body">{infoContent.text}</p>
        <button onClick={() => setInfoContent(null)} className="absolute top-3 right-3 text-slate-500 hover:text-white"><X className="w-5 h-5" /></button>
      </div>
    </div>
  );
};

const SmartOwnerRoute = ({ venues, handleUpdateVenue, userProfile }: any) => {
  const [searchParams] = useSearchParams();
  const venueIdParam = searchParams.get('venueId');
  const tabParam = searchParams.get('tab');
  const navigate = useNavigate();

  const isAuthorized = isSystemAdmin(userProfile) || (userProfile.venuePermissions && Object.keys(userProfile.venuePermissions).length > 0);

  if (!isAuthorized) {
    return <OwnerPortal />;
  }

  // Determine initial view based on tab param
  let initialView: any = 'main';
  if (tabParam === 'menu') initialView = 'menu';
  if (tabParam === 'listing') initialView = 'listing';
  if (tabParam === 'marketing') initialView = 'marketing';
  if (tabParam === 'events') initialView = 'events';

  const defaultVenueId = venueIdParam || (isSystemAdmin(userProfile) && (!userProfile.venuePermissions || Object.keys(userProfile.venuePermissions).length === 0)
    ? 'hannahs'
    : (userProfile.venuePermissions ? Object.keys(userProfile.venuePermissions)[0] : null));

  return (
    <OwnerDashboardScreen
      isOpen={true}
      onClose={() => navigate('/')}
      venues={venues}
      updateVenue={handleUpdateVenue}
      userProfile={userProfile}
      initialVenueId={defaultVenueId}
      initialView={initialView}
    />
  );
};

export default function OlyBarsApp() {
  // --- DATA FETCHING (TanStack Query with Persistence) ---
  const { data: venues = [], isLoading } = useQuery({
    queryKey: ['venues-brief'],
    queryFn: () => fetchVenues(true), // Fetch brief mode for the list
    staleTime: 60 * 1000,
    gcTime: 10 * 60 * 1000,
  });

  // Sync Venues to LocalStorage for next boot
  useEffect(() => {
    if (venues && venues.length > 0) {
      localStorage.setItem('oly_venues_cache', JSON.stringify(venues));
    }
  }, [venues]);

  const [userPoints, setUserPoints] = useState(() => parseInt(localStorage.getItem('oly_points') || '0'));
  const [clockInHistory, setClockInHistory] = useState<ClockInRecord[]>(() => JSON.parse(localStorage.getItem('oly_clockins') || '[]'));
  const [alertPrefs, setAlertPrefs] = useState<UserAlertPreferences>(() => JSON.parse(localStorage.getItem('oly_prefs') || '{"nightlyDigest":true,"weeklyDigest":true,"followedVenues":[],"interests":[]}'));
  const [userProfile, setUserProfile] = useState<UserProfile>(() => {
    try {
      const stored = localStorage.getItem('oly_profile');
      if (!stored || stored === 'null' || stored === 'undefined') {
        return { uid: 'guest', role: 'guest' };
      }
      return JSON.parse(stored);
    } catch {
      return { uid: 'guest', role: 'guest' };
    }
  });

  const userId = userProfile?.uid || "guest_user_123";

  const [showLoginModal, setShowLoginModal] = useState(false);
  const [loginMode, setLoginMode] = useState<'user' | 'owner'>('user');
  const [userSubMode, setUserSubMode] = useState<'login' | 'signup'>('signup');
  const [showOwnerDashboard, setShowOwnerDashboard] = useState(false);
  const [ownerDashboardInitialVenueId, setOwnerDashboardInitialVenueId] = useState<string | null>(null);
  const [ownerDashboardInitialView, setOwnerDashboardInitialView] = useState<'main' | 'marketing' | 'listing'>('main');
  const [hasAcceptedAgeGate, setHasAcceptedAgeGate] = useState(() => cookieService.get('oly_age_gate') === 'true');
  const [hasAcceptedTerms, setHasAcceptedTerms] = useState(() => cookieService.get('oly_terms') === 'true');
  const [infoContent, setInfoContent] = useState<{ title: string, text: string } | null>(null);
  const [showClockInModal, setShowClockInModal] = useState(false);
  const [selectedVenue, setSelectedVenue] = useState<Venue | null>(null);
  const [vibeVenue, setVibeVenue] = useState<Venue | null>(null);
  const [showVibeCheckModal, setShowVibeCheckModal] = useState(false);
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [clockedInVenue, setClockedInVenue] = useState<string | null>(null);
  const [vibeCheckedVenue, setVibeCheckedVenue] = useState<string | null>(null);
  const [showArtie, setShowArtie] = useState(false);
  const [chatInput, setChatInput] = useState('');
  const [showMakerSurvey, setShowMakerSurvey] = useState(false); // Survey State
  const [currentReceipt, setCurrentReceipt] = useState<VibeReceiptData | null>(null);
  const { showToast } = useToast();
  // const [artieMessages, setArtieMessages] = useState<{ sender: string, text: string }[]>([
  //   { sender: 'artie', text: "Cheers! I'm Artie, your local guide powered by Well 80 Artesian Water." }
  // ]);
  const [userRank, setUserRank] = useState<number | undefined>(undefined);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const getRank = async () => {
      if (userProfile.uid !== 'guest' && userPoints !== undefined) {
        const rank = await fetchUserRank(userPoints);
        setUserRank(rank);
      }
    };
    getRank();
  }, [userPoints, userProfile.uid]);

  // Persistence Layer (Sync State to LocalStorage)
  useEffect(() => {
    if (userProfile) {
      localStorage.setItem('oly_profile', JSON.stringify(userProfile));
    }
  }, [userProfile]);

  useEffect(() => {
    localStorage.setItem('oly_points', userPoints.toString());
  }, [userPoints]);

  useEffect(() => {
    localStorage.setItem('oly_clockins', JSON.stringify(clockInHistory));
  }, [clockInHistory]);

  useEffect(() => {
    localStorage.setItem('oly_prefs', JSON.stringify(alertPrefs));
  }, [alertPrefs]);

  // Maker's Trail Survey Trigger: 3 Local Clock Ins and Survey Not Done
  useEffect(() => {
    if (userProfile.uid !== 'guest' &&
      userProfile.makersTrailProgress &&
      userProfile.makersTrailProgress >= 3 &&
      !userProfile.hasCompletedMakerSurvey &&
      !showMakerSurvey) {
      // Add a small delay for UX so it doesn't pop immediately after action
      const timer = setTimeout(() => setShowMakerSurvey(true), 2000);
      return () => clearTimeout(timer);
    }
  }, [userProfile.makersTrailProgress, userProfile.hasCompletedMakerSurvey, userProfile.uid]);

  const openInfo = (title: string, text: string) => { setInfoContent({ title, text }); };

  const awardPoints = (reason: PointsReason, venueId?: string, hasConsent?: boolean, verificationMethod?: 'gps' | 'qr', bonusPoints: number = 0, skipBackend: boolean = false) => {
    let delta = 0;
    if (reason === 'clockin' || reason === 'photo') delta = 10;
    else if (reason === 'share' || reason === 'social_share') delta = 5;
    else if (reason === 'vibe') delta = hasConsent ? 20 : 5;

    if (hasConsent && (reason as string) !== 'vibe') delta += 15; // Generic bonus for consent if not vibe

    delta += bonusPoints;

    setUserPoints(prev => prev + delta);

    if (reason === 'vibe' && venueId) {
      const now = Date.now();
      setUserProfile(prev => ({
        ...prev,
        lastGlobalVibeCheck: now,
        lastVibeChecks: {
          ...prev.lastVibeChecks,
          [venueId]: now
        }
      }));
    }

    if (!skipBackend) {
      logUserActivity(userId, { type: reason, venueId, hasConsent, points: delta, verificationMethod });
    }
  };

  const handleUpdateVenue = async (venueId: string, updates: Partial<Venue>) => {
    // 1. Optimistic UI Update (TanStack Query Cache)
    queryClient.setQueryData(['venues-brief'], (oldVenues: Venue[] | undefined) => {
      if (!oldVenues) return [];
      return oldVenues.map(v => v.id === venueId ? { ...v, ...updates } : v);
    });

    // 2. Persist to Backend
    try {
      await updateVenueDetails(venueId, updates, userProfile.uid);
    } catch (err: any) {
      console.error('[OlyBars] Failed to persist venue update:', err);
      showToast(err.message || 'Connection issue: Update might not be permanent.', 'error');
      // Invalidate on error to revert to server state
      queryClient.invalidateQueries({ queryKey: ['venues-brief'] });
      throw err; // Re-throw so callers can manage their own UI state (e.g. isSaving)
    }
  };

  const handleClockIn = (venue: Venue) => {
    const now = Date.now();

    // 1. Calculate OlyBars Business Day Start (4:00 AM)
    if (clockedInVenue === venue.id) {
      showToast("You're already clocked in here!", 'info');
      return;
    }

    setSelectedVenue(venue);
    setShowClockInModal(true);
  };

  const handleVibeCheck = (venue: Venue) => {
    const now = Date.now();

    // 1. Global Cooldown (30m)
    const lastGlobal = userProfile.lastGlobalVibeCheck;
    if (lastGlobal && (now - lastGlobal) < 30 * 60 * 1000) {
      const minsLeft = Math.ceil((30 * 60 * 1000 - (now - lastGlobal)) / 60000);
      showToast(`Global Cooldown! Wait ${minsLeft}m before clocking another vibe.`, 'info');
      return;
    }

    // 2. Per-Venue Cooldown (60m)
    const lastCheck = userProfile.lastVibeChecks?.[venue.id];
    if (lastCheck && (now - lastCheck) < 60 * 60 * 1000) {
      const minsLeft = Math.ceil((60 * 60 * 1000 - (now - lastCheck)) / 60000);
      showToast(`${venue.name} Vibe Check locked! Available in ${minsLeft}m`, 'info');
      return;
    }

    setVibeVenue(venue);
    setShowVibeCheckModal(true);
  };

  const confirmVibeCheck = async (venue: Venue, status: VenueStatus, hasConsent: boolean, photoUrl?: string, verificationMethod: 'gps' | 'qr' = 'gps', gameStatus?: Record<string, GameStatus>, soberFriendlyCheck?: { isGood: boolean; reason?: string }) => {
    const now = Date.now();

    // 1. If not already clocked in, perform a background Clock In to unify signals
    if (!clockedInVenue || clockedInVenue !== venue.id) {
      setClockedInVenue(venue.id);
      setClockInHistory(prev => [...prev, { venueId: venue.id, timestamp: now }]);
    }

    setVibeCheckedVenue(venue.id);

    // Calculate Game Bonus Points
    let gameBonus = 0;
    if (gameStatus && Object.keys(gameStatus).length > 0) {
      // 2 points per game reported, max 10
      const gameCount = Object.keys(gameStatus).length;
      gameBonus = Math.min(gameCount * 2, 10);
    }

    // Update Venue Status and Photos (Attempt for all, handle guest auth errors)
    try {
      await performVibeCheck(venue.id, userProfile.uid, status, hasConsent, photoUrl, verificationMethod, gameStatus, soberFriendlyCheck);
    } catch (err: any) {
      // Honest Gate: Propagate Auth Errors for Guest UI handling
      if (userProfile.uid === 'guest' && (err.status === 401 || err.status === 403)) {
        throw err;
      }
      console.error('[OlyBars] Vibe Check Backend Error:', err);
      showToast('Vibe Check recorded offline (points may be delayed)', 'info');
    }

    awardPoints('vibe', venue.id, hasConsent, verificationMethod, gameBonus, userProfile.uid !== 'guest');

    // Generate Vibe Receipt
    const receipt: VibeReceiptData = {
      type: 'vibe',
      venueName: venue.name,
      venueId: venue.id,
      pointsEarned: (hasConsent ? 20 : 5) + (photoUrl ? 10 : 0) + gameBonus,
      vibeStatus: status,
      artieHook: generateArtieHook('vibe', status, { gameBonus }),
      username: userProfile.handle || userProfile.displayName || 'Member',
      userId: userProfile.uid,
      timestamp: new Date().toISOString(),
      metadata: {
        gameBonus,
        gamesUpdated: gameStatus ? Object.keys(gameStatus) : []
      }
    };
    setCurrentReceipt(receipt);
  };

  const handleToggleWeeklyBuzz = async () => {
    const newVal = !userProfile.weeklyBuzz;

    // 1. Update Profile (Local + Remote)
    setUserProfile(prev => ({ ...prev, weeklyBuzz: newVal }));

    // 2. Update Alert Prefs (Local) to keep synced
    setAlertPrefs(prev => ({ ...prev, weeklyDigest: newVal }));

    // 3. Persist to Firestore
    if (userProfile.uid !== 'guest') {
      try {
        await updateUserProfile(userProfile.uid, { weeklyBuzz: newVal });
      } catch (e) {
        showToast('Sync failed, retrying...', 'error');
      }
    }
  };

  const handleMemberLoginClick = (mode: 'login' | 'signup' = 'signup') => {
    setUserSubMode(mode);
    setLoginMode('user');
    setShowLoginModal(true);
  };

  const handleToggleFavorite = async (venueId: string) => {
    if (userProfile.uid === 'guest') {
      // Allow local toggle without login modal
    }

    try {
      const result = await toggleFavorite(userProfile.uid, venueId, userProfile.favorites || []);
      if (result.success) {
        setUserProfile(prev => ({ ...prev, favorites: result.favorites }));
        showToast(userProfile.favorites?.includes(venueId) ? 'Removed from Favorites' : 'Added to Favorites', 'success');
      }
    } catch (e) {
      showToast('Error updating favorites', 'error');
    }
  };

  const handleAcceptAgeGate = () => {
    cookieService.set('oly_age_gate', 'true');
    cookieService.set('oly_terms', 'true');
    setHasAcceptedAgeGate(true);
    setHasAcceptedTerms(true);
  };

  const handleAcceptTerms = () => {
    cookieService.set('oly_terms', 'true');
    // We don't set oly_cookies here automatically so the banner shows up separately
    setHasAcceptedTerms(true);
  };

  useEffect(() => { localStorage.setItem('oly_points', userPoints.toString()); }, [userPoints]);
  useEffect(() => { localStorage.setItem('oly_clockins', JSON.stringify(clockInHistory)); }, [clockInHistory]);
  useEffect(() => { localStorage.setItem('oly_profile', JSON.stringify(userProfile)); }, [userProfile]);
  useEffect(() => { localStorage.setItem('oly_prefs', JSON.stringify(alertPrefs)); if (userId !== 'guest') saveAlertPreferences(userId, alertPrefs); }, [alertPrefs]);

  const handleLogout = () => {
    localStorage.removeItem('oly_profile');
    localStorage.removeItem('oly_points');
    localStorage.removeItem('oly_clockins');
    setUserProfile({ uid: 'guest', role: 'guest' });
    setUserPoints(1250);
    setClockInHistory([]);
    setShowOwnerDashboard(false);
    window.location.href = '/';
  };

  // Sync points when profile changes (e.g. after login)
  useEffect(() => {
    if (userProfile.stats?.seasonPoints !== undefined) {
      setUserPoints(userProfile.stats.seasonPoints);
    }
  }, [userProfile.uid, userProfile.stats?.seasonPoints]);

  if (!hasAcceptedAgeGate) {
    return <AgeGate onAccept={handleAcceptAgeGate} />;
  }

  if (!hasAcceptedTerms && userProfile.role !== 'guest') {
    return <OnboardingModal isOpen={true} onClose={handleAcceptTerms} userRole={userProfile.role} />;
  }

  return (
    <ErrorBoundary>
      <Router>
        <DiscoveryProvider>
          <ScrollToTop />
          <div className="h-full bg-background overflow-hidden relative">
            <Routes>
              <Route
                path="*"
                element={
                  <AppShell
                    venues={venues}
                    userPoints={userPoints}
                    isLeagueMember={userProfile.role !== 'guest'}
                    alertPrefs={alertPrefs}
                    setAlertPrefs={setAlertPrefs}
                    onToggleWeeklyBuzz={handleToggleWeeklyBuzz}
                    onProfileClick={() => {
                      if (userProfile.uid === 'guest') {
                        setLoginMode('user');
                        setUserSubMode('login');
                        setShowLoginModal(true);
                      } else {
                        // Use document location for SPA feel or navigation handler
                        window.history.pushState({}, '', '/profile');
                        // Since we aren't using a router hook at this level, 
                        // we need to trigger a re-render or use a shared navigation handler.
                        // However, routes are defined below. 
                        // To keep it simple and fix the "reload" issue:
                        const popStateEvent = new PopStateEvent('popstate');
                        window.dispatchEvent(popStateEvent);
                      }
                    }}
                    onOwnerLoginClick={() => {
                      setLoginMode('owner');
                      setUserSubMode('login');
                      setShowLoginModal(true);
                    }}
                    onMemberLoginClick={(mode?: 'login' | 'signup') => {
                      setLoginMode('user');
                      if (mode) setUserSubMode(mode);
                      setShowLoginModal(true);
                    }}
                    userRole={userProfile.role}
                    userHandle={userProfile.handle}
                    userRank={userRank}
                    onLogout={handleLogout}
                    userProfile={userProfile}
                    onToggleFavorite={handleToggleFavorite}
                    onClockIn={handleClockIn}
                    onVibeCheck={handleVibeCheck}
                    clockedInVenue={clockedInVenue}
                    onEditVenue={(vid) => {
                      setOwnerDashboardInitialVenueId(vid);
                      setOwnerDashboardInitialView('listing');
                      setShowOwnerDashboard(true);
                    }}
                    onVenueDashboardClick={() => setShowOwnerDashboard(true)}
                    showArtie={showArtie}
                    setShowArtie={setShowArtie}
                  />
                }
              >
                <Route element={<DiscoveryLayout />}>
                  <Route
                    index
                    element={
                      <>
                        <SEO
                          title="Pulse & Buzz"
                          description="Track the real-time vibe of Thurston County. See which bars are buzzing right now."
                        />
                        <BuzzScreen />
                      </>
                    }
                  />
                  <Route
                    path="venues"
                    element={
                      <>
                        <SEO title="Bar Directory" description="The complete index of bars, taprooms, and lounges in Thurston County." />
                        <VenuesScreen venues={venues} />
                      </>
                    }
                  />
                  <Route
                    path="venues/:id"
                    element={
                      <VenueProfileScreen />
                    }
                  />
                  <Route
                    path="back-room"
                    element={
                      <>
                        <SEO title="The Back Room" description="Private inventory for squads & parties." />
                        <BackRoomScreen />
                      </>
                    }
                  />
                </Route>
                <Route path="karaoke" element={<><SEO title="Karaoke Guide" description="Find the best karaoke spots in Thurston County tonight." /><KaraokeScreen venues={venues} /></>} />
                <Route path="play" element={<><SEO title="The Arcade & Arena" description="The central hub for games, events, and activities in Thurston County." /><PlayGatewayScreen venues={venues} /></>} />
                <Route path="trivia" element={<><SEO title="Trivia & Games" description="Your guide to trivia nights and bar games in Thurston County." /><TriviaScreen venues={venues} userProfile={userProfile} /></>} />
                <Route path="live" element={<><SEO title="Live Music" description="Live shows and concerts happening tonight in Thurston County." /><LiveMusicScreen venues={venues} /></>} />
                <Route path="events" element={<><SEO title="Event Wire" description="The chronological feed of everything happening in the Thurston County bar scene." /><EventsScreen venues={venues} /></>} />
                <Route
                  path="league"
                  element={
                    <>
                      <SEO title="Bar League HQ" description="Join the official Artesian Bar League. Track your points, rankings, and rewards." />
                      <LeagueHQScreen
                        venues={venues}
                        isLeagueMember={userProfile.role !== 'guest'}
                        onJoinClick={(mode) => {
                          setUserSubMode(mode || 'login');
                          setLoginMode('user');
                          setShowLoginModal(true);
                        }}
                        onAskArtie={() => setShowArtie(true)}
                      />
                    </>
                  }
                />
                <Route path="partners/claim" element={<ClaimVenuePage />} />
                <Route path="merch" element={<MerchStandScreen venues={venues} />} />
                <Route path="merch/:itemId" element={<MerchDetailScreen venues={venues} userProfile={userProfile} setUserProfile={setUserProfile} />} />
                <Route path="vouchers" element={<VoucherRedemptionScreen userProfile={userProfile} venues={venues} />} />
                <Route path="meet-artie" element={<ArtieBioScreen />} />
                <Route path="artie-bio" element={<ArtieBioScreen />} />
                <Route path="artie" element={<ArtieBioScreen />} />
                <Route path="owner" element={<SmartOwnerRoute venues={venues} handleUpdateVenue={handleUpdateVenue} userProfile={userProfile} />} />
                <Route
                  path="vc/:venueId"
                  element={
                    <QRVibeCheckScreen
                      venues={venues}
                      handleVibeCheck={confirmVibeCheck}
                    />
                  }
                />
                <Route
                  path="profile"
                  element={
                    userProfile.uid !== 'guest'
                      ? <UserProfileScreen userProfile={userProfile} setUserProfile={setUserProfile} venues={venues} />
                      : <div className="p-10 text-center font-black text-primary uppercase tracking-widest">
                        Access Denied: Please Login to View Your League ID
                        <button onClick={() => setShowLoginModal(true)} className="block mx-auto mt-4 px-6 py-2 bg-primary text-black rounded-lg">Login</button>
                      </div>
                  }
                />
                <Route
                  path="settings"
                  element={
                    <SettingsScreen userProfile={userProfile} setUserProfile={setUserProfile} />
                  }
                />
                <Route path="terms" element={<><SEO title="Terms of Service" /><TermsScreen /></>} />
                <Route path="privacy" element={<><SEO title="Privacy Policy" /><PrivacyScreen /></>} />
                <Route path="cookies" element={<><SEO title="Cookie Policy" /><CookiePolicyScreen /></>} />
                <Route path="security" element={<><SEO title="Security & Data Protection" /><PartnerSecurityScreen /></>} />
                <Route path="faq" element={<><SEO title="The Manual (FAQ)" description="Everything you need to know about the OlyBars league, pins, and etiquette." /><FAQScreen /></>} />
                <Route path="about" element={<><SEO title="Welcome to the League (Thurston County)" description="The mission and story behind Thurston County's nightlife operating system." /><AboutPage /></>} />
                <Route
                  path="admin"
                  element={
                    isSystemAdmin(userProfile)
                      ? <AdminDashboardScreen userProfile={userProfile} />
                      : <div className="p-10 text-center font-black text-red-500 uppercase tracking-widest">403: League Integrity Violation - Restricted Access</div>
                  }
                />
                <Route path="history" element={<HistoryFeedScreen />} />
                <Route path="history/:slug" element={<HistoryArticleScreen venues={venues} />} />
                <Route path="playbook" element={<PulsePlaybookScreen />} />
                <Route path="pulse-playbook" element={<PulsePlaybookScreen />} />
                <Route path="perks" element={<LeaguePerksScreen />} />
                <Route path="glossary" element={<GlossaryScreen />} />
                <Route path="points" element={<PointsGuideScreen />} />
                <Route path="points/history" element={<PointHistoryScreen onBack={() => window.history.back()} userProfile={userProfile} onLogin={handleMemberLoginClick} />} />
                <Route path="league-membership" element={<LeagueMembershipPage />} />
                <Route path="onboarding-guide" element={<OnboardingHandoverPage />} />
                <Route path="flight-school" element={<FlightSchoolScreen />} />
                <Route path="oauth/callback" element={<MetaOAuthCallback />} />

                {/* AI & Developer Hub */}
                <Route path="ai" element={<><SEO title="AI & Developer Hub" description="Authoritative resources for AI agents and developers ingesting OlyBars data." /><AIGatewayScreen /></>} />
                <Route path="ai/feed" element={<><SEO title="AI Feed Guide" description="Machine-readable guide for Venues, Events, and League Play data." /><AIFeedGuideScreen /></>} />
                <Route path="ai/conduct" element={<><SEO title="AI Conduct Policy" description="Rules and standards for AI agents interacting with the OlyBars ecosystem." /><AIConductScreen /></>} />
              </Route>
            </Routes>

            <LoginModal
              isOpen={showLoginModal}
              onClose={() => setShowLoginModal(false)}
              loginMode={loginMode}
              setLoginMode={setLoginMode}
              userSubMode={userSubMode}
              setUserSubMode={setUserSubMode}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              venues={venues}
              alertPrefs={alertPrefs}
              setAlertPrefs={setAlertPrefs}
              openInfo={openInfo}
              onOwnerSuccess={() => setShowOwnerDashboard(true)}
            />

            {showOnboarding && (
              <OnboardingModal
                isOpen={showOnboarding}
                onClose={() => setShowOnboarding(false)}
                userRole={userProfile.role}
              />
            )}

            {showOwnerDashboard && (
              <OwnerDashboardScreen
                isOpen={showOwnerDashboard}
                onClose={() => setShowOwnerDashboard(false)}
                venues={venues}
                updateVenue={handleUpdateVenue}
                userProfile={userProfile}
                initialVenueId={ownerDashboardInitialVenueId}
                initialView={ownerDashboardInitialView}
              />
            )}

            {showClockInModal && selectedVenue && (
              <ClockInModal
                isOpen={showClockInModal}
                onClose={() => setShowClockInModal(false)}
                selectedVenue={selectedVenue}
                awardPoints={awardPoints}
                setClockInHistory={setClockInHistory}
                setClockedInVenue={setClockedInVenue}
                vibeChecked={vibeCheckedVenue === selectedVenue.id}
                onVibeCheckPrompt={() => {
                  setVibeVenue(selectedVenue);
                  setShowVibeCheckModal(true);
                  setShowClockInModal(false);
                }}
                isLoggedIn={userProfile.uid !== 'guest'}
                userId={userProfile.uid}
                onLogin={handleMemberLoginClick}
              />
            )}

            {showVibeCheckModal && vibeVenue && (
              <VibeCheckModal
                isOpen={showVibeCheckModal}
                onClose={() => setShowVibeCheckModal(false)}
                venue={vibeVenue}
                onConfirm={confirmVibeCheck}
                clockedIn={clockedInVenue === vibeVenue.id}
                onClockInPrompt={() => {
                  setSelectedVenue(vibeVenue);
                  setShowClockInModal(true);
                  setShowVibeCheckModal(false);
                }}
                isLoggedIn={userProfile.uid !== 'guest'}
                onLogin={handleMemberLoginClick}
              />
            )}

            {showMakerSurvey && (
              <MakerSurveyModal
                isOpen={showMakerSurvey}
                onClose={() => {
                  setShowMakerSurvey(false);
                  // Optimistic update to prevent re-trigger in this session
                  setUserProfile(prev => ({ ...prev, hasCompletedMakerSurvey: true }));
                }}
                userId={userProfile.uid}
              />
            )}

            {currentReceipt && (
              <VibeReceiptModal
                data={currentReceipt}
                onClose={() => setCurrentReceipt(null)}
                isLoggedIn={userProfile.uid !== 'guest'}
                onLogin={handleMemberLoginClick}
              />
            )}

            <InfoPopup infoContent={infoContent} setInfoContent={setInfoContent} />
          </div>
        </DiscoveryProvider>
      </Router>
    </ErrorBoundary >
  );
}
